---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
---

<Layout title="Générateur IA - TaVue">
  <Header />
  
  <main class="min-h-screen pt-20 px-6 lg:px-10 bg-black">
    <!-- Hero Section -->
    <div class="container mx-auto">
      <div class="flex items-center justify-between mb-8">
        <div>
          <span class="px-4 py-1 bg-yellow-500 text-black text-sm font-bold rounded">IA GÉNÉRATIVE</span>
          <h1 class="text-4xl lg:text-5xl font-light text-white mt-4">
            Créez vos lunettes avec <span class="text-yellow-500 font-serif italic">l'intelligence artificielle</span>
          </h1>
          <p class="text-gray-400 mt-2">Décrivez votre vision, l'IA la transforme en design unique</p>
        </div>
      </div>

      <!-- Grid principal -->
      <div class="grid lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
        
        <!-- Colonne gauche : Prompt et Contrôles -->
        <div class="space-y-6">
          <!-- Carte Prompt -->
          <div class="bg-zinc-900 rounded-2xl p-6 border border-white/10">
            <div class="flex items-center gap-2 mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              <h2 class="text-xl font-light text-white">Décrivez vos lunettes</h2>
            </div>
            
            <textarea
              id="user-prompt"
              class="w-full bg-black border border-white/20 rounded-lg p-4 text-white min-h-[150px] focus:border-yellow-500 focus:outline-none transition-colors resize-none"
              placeholder="Ex: Des lunettes rondes vintage avec des branches dorées et des verres légèrement teintés"></textarea>
            
            <!-- Suggestions rapides -->
            <div class="mt-4 space-y-2">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Suggestions :</p>
              <div class="flex flex-wrap gap-2">
                <button class="suggestion-btn px-3 py-1 bg-white/5 hover:bg-yellow-500/20 border border-white/10 hover:border-yellow-500 rounded text-xs text-gray-300 hover:text-yellow-500 transition-all">
                  Aviateur classique
                </button>
                <button class="suggestion-btn px-3 py-1 bg-white/5 hover:bg-yellow-500/20 border border-white/10 hover:border-yellow-500 rounded text-xs text-gray-300 hover:text-yellow-500 transition-all">
                  Ronde minimaliste
                </button>
                <button class="suggestion-btn px-3 py-1 bg-white/5 hover:bg-yellow-500/20 border border-white/10 hover:border-yellow-500 rounded text-xs text-gray-300 hover:text-yellow-500 transition-all">
                  Cat-eye élégante
                </button>
                <button class="suggestion-btn px-3 py-1 bg-white/5 hover:bg-yellow-500/20 border border-white/10 hover:border-yellow-500 rounded text-xs text-gray-300 hover:text-yellow-500 transition-all">
                  Sport futuriste
                </button>
              </div>
            </div>
            
            <div class="flex gap-3 mt-6">
              <button id="generate-button" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-black font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Générer avec l'IA
              </button>
              <button id="clear-button" class="px-6 py-3 border border-white/20 hover:border-white/40 text-white rounded-lg transition-all">
                Effacer
              </button>
            </div>
            
            <p id="error-msg" class="text-red-500 text-sm mt-3 hidden"></p>
          </div>

          <!-- Carte Actions -->
          <div class="bg-zinc-900 rounded-2xl p-6 border border-white/10">
            <h3 class="text-lg font-light text-white mb-4">Actions</h3>
            <div class="flex flex-wrap gap-3">
              <button id="copy-code" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 rounded-lg transition-all text-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                Copier le code
              </button>
              <button id="download-svg" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 rounded-lg transition-all text-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Télécharger .svg
              </button>
              <button id="save-svg" class="px-4 py-2 bg-yellow-500/10 hover:bg-yellow-500/20 border border-yellow-500/30 text-yellow-500 rounded-lg transition-all text-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Enregistrer
              </button>
            </div>
            <p id="save-msg" class="text-sm mt-3"></p>
          </div>
        </div>

        <!-- Colonne droite : Aperçu et Code -->
        <div class="space-y-6">
          <!-- Aperçu SVG -->
          <div class="bg-zinc-900 rounded-2xl p-6 border border-white/10">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-light text-white">Aperçu</h2>
              <div class="flex items-center gap-2 text-yellow-500 text-xs">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span>Généré par IA</span>
              </div>
            </div>
            
            <div
              id="svg-container"
              class="w-full aspect-square bg-black rounded-lg flex items-center justify-center border border-white/10 overflow-hidden">
              <div class="text-center text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <p class="text-sm">Votre design apparaîtra ici</p>
              </div>
            </div>
          </div>

          <!-- Code SVG -->
          <div class="bg-zinc-900 rounded-2xl p-6 border border-white/10">
            <h3 class="text-lg font-light text-white mb-4">Code SVG</h3>
            <div class="bg-black rounded-lg p-4 max-h-[300px] overflow-auto border border-white/10">
              <pre class="text-xs text-gray-400"><code id="svg-output">&lt;!-- Le code SVG apparaîtra ici --&gt;</code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/10 py-12 px-6 lg:px-10 mt-20">
    <div class="container mx-auto text-center space-y-6">
      <nav class="flex justify-center gap-6 text-sm text-gray-400">
        <a href="/mentions-legales" class="hover:text-yellow-500 transition-colors">Mentions légales</a>
        <span class="text-white/20">|</span>
        <a href="/cgv" class="hover:text-yellow-500 transition-colors">CGV</a>
        <span class="text-white/20">|</span>
        <a href="/contact" class="hover:text-yellow-500 transition-colors">Contact</a>
      </nav>
      <p class="text-yellow-500 font-serif text-sm">
        Fabrication française – Artisanat d'excellence
      </p>
    </div>
  </footer>

  <script>
    // @ts-nocheck

    // ---- API calls ----
    async function generateSVG(prompt) {
      const res = await fetch("/api/generateSVG", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt }),
      });
      if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        throw new Error(e.error || ("HTTP " + res.status));
      }
      const data = await res.json();
      const raw = data?.svg;
      return typeof raw === "string" ? raw : (raw?.content ?? "");
    }

    async function saveToPocketBase(prompt, svg) {
      const user = JSON.parse(localStorage.getItem("currentUser") || "null");
      const res = await fetch("/api/saveSVG", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          title: prompt,
          code_svg: svg,
          chat_history: [],
          ...(user?.id ? { user: user.id } : {}),
        }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) {
        throw new Error(data?.error || ("HTTP " + res.status));
      }
      return data.id || data.record?.id;
    }

    // ---- UI handlers ----
    async function handleSubmit() {
      const promptEl = document.getElementById("user-prompt");
      const svgContainer = document.getElementById("svg-container");
      const svgOutput = document.getElementById("svg-output");
      const generateButton = document.getElementById("generate-button");
      const errorMsg = document.getElementById("error-msg");

      const prompt = (promptEl?.value || "").trim();
      errorMsg.classList.add("hidden");
      if (!prompt) {
        errorMsg.textContent = "Merci d'entrer un prompt.";
        errorMsg.classList.remove("hidden");
        return;
      }

      svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;
      generateButton.disabled = true;

      try {
        const svg = await generateSVG(prompt);
        svgOutput.textContent = svg || "<!-- Pas de SVG détecté -->";
        svgContainer.innerHTML = svg || `<div class="text-sm opacity-60">Aucun &lt;svg&gt; trouvé</div>`;
      } catch (err) {
        svgOutput.textContent = `<!-- Erreur: ${err.message} -->`;
        svgContainer.innerHTML = `<div class="text-error">${err.message}</div>`;
      } finally {
        generateButton.disabled = false;
      }
    }

    function handleClear() {
      document.getElementById("user-prompt").value = "";
      document.getElementById("svg-output").textContent = "<!-- SVG -->";
      document.getElementById("svg-container").innerHTML = `<span class="opacity-60">Aperçu</span>`;
      document.getElementById("error-msg").classList.add("hidden");
      document.getElementById("save-msg").textContent = "";
    }

    function handleCopy() {
      const code = document.getElementById("svg-output").textContent || "";
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById("copy-code");
        const old = btn.textContent;
        btn.textContent = "Copié !";
        setTimeout(() => (btn.textContent = old), 900);
      });
    }

    function handleDownload() {
      const code = document.getElementById("svg-output").textContent || "";
      if (!code.includes("<svg")) return;
      const blob = new Blob([code], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "generated.svg";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function handleSave() {
      const prompt = (document.getElementById("user-prompt").value || "").trim();
      const svg = document.getElementById("svg-output").textContent || "";
      const msg = document.getElementById("save-msg");
      msg.textContent = "";

      if (!svg.includes("<svg")) {
        msg.textContent = "Aucun SVG à enregistrer.";
        msg.className = "text-error text-sm mt-2";
        return;
      }

      const btn = document.getElementById("save-svg");
      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Enregistrement…";

      try {
        const id = await saveToPocketBase(prompt, svg);
        msg.textContent = "Enregistré ! id = " + id;
        msg.className = "text-success text-sm mt-2";
      } catch (e) {
        msg.textContent = "Erreur d’enregistrement : " + e.message;
        msg.className = "text-error text-sm mt-2";
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // ---- Listeners ----
    document.getElementById("generate-button")?.addEventListener("click", handleSubmit);
    document.getElementById("clear-button")?.addEventListener("click", handleClear);
    document.getElementById("copy-code")?.addEventListener("click", handleCopy);
    document.getElementById("download-svg")?.addEventListener("click", handleDownload);
    document.getElementById("save-svg")?.addEventListener("click", handleSave);
  </script>
</Layout>
